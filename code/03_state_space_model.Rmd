---
title: "状態空間モデル"
output:
  html_document:
    code_folding: show
    self_contained: true
    number_section: true
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# 状態方程式・観測方程式

線形ガウス状態空間モデルは下記のように定式化される。  
上が状態方程式、下が観測方程式。  



$$
\begin{aligned}
x_{t}&=T_{t}x_{t-1}+R_{t}\xi _{t}, &~~~~~~\xi _{t}\sim N\left( 0,Q_{t}\right)\\
y_{t}&=Z_{t}x_{t}+\varepsilon_{t}, &~~~~~~\varepsilon _{t}\sim N\left( 0,H_{t}\right) 
\end{aligned}\tag{1}
$$

$x_{t}$は$t$時点の状態を表す。状態は、$k$次元のベクトルを取る。つまり、状態を様々な要素の和として表現することができる。  
$y_{t}$は$t$時点の観測値。$T_{t}, R_{t}, Z_{t}$はモデルの表現形式を決める行列となる。  

日本語だと以下の表現になる。  



$$
\begin{aligned}
状態 &= 前時点の状態を用いた予測値 + 過程誤差\\
観測 &= 状態 + 観測誤差
\end{aligned}\tag{2}
$$

#  データの表現とパラメタ推定

データの表現とパラメタ推定は分けて理解すべき。  

## データの表現
データの表現は、状態方程式と観測方程式で表される。 


## パラメータ推定

～フィルタ系と、MCMCを用いるグループの大きく2つに分かれる。  
フィルタリングの代表としては、カルマンフィルタが有名。   
MCMCの代表として、HMC法など。  
最も有名な方法は、カルマンフィルタ+最尤法。  




# 状態推定：予測とフィルタリング

フィルタリングは、手に入った**観測値を用いて予測された状態の値を補正**することを指す。  
状態方程式における状態の更新式を用いて予測を行う。

![](../images/00_predict_step.png)
   
最新の観測地を用いて即座に誤りを補正し、次の予測を行うことができる。  
カルマンフィルタを用いると、これらの計算を効率よく行うことができる。  


# 状態推定：平滑化

平滑化はすべてのデータが整った後に、状態の補正を行う計算を指す。  
未来の観測地を使って、過去の状態を補正しても予測の精度は上がらないが、補正に使われる情報が増えるため、ノイズの影響を軽減できる。  


# パラメタ推定：最尤法

観測データを用いて状態を補正するためにはいくつかの情報が必要。  
代表的な情報として、過程誤差の分散と、観測誤差の分散。  

 - 過程誤差が大きい
   - Step1の予測の当たりが悪い事を意味する。予測された未来の状態の精度が悪いので、「観測値を用いた状態の補正」が必要な状態。
   
 - 観測誤差が大きい
   - 観測地をあまり信用できないことを意味する。信用度が低いということは「観測値を用いた状態の補正」はあまり行わない方がいい状態。
   
つまり、**何方の誤差の大きさの比率を勘案しつつ、フィルタリング（状態の補正）を行う**という事。  

このために最尤法を用いたパラメタ推定が行われる。



 1. まずは、根拠なしにとりあえずパラメタを設定し、カルマンフィルタを実行する。
 2. すると、テキトーに状態の補正が行われてしまう事になる。これを逐次評価して、パラメタの微修正を繰り返すことで最適なパラメタを探す。  
 この時の評価指標を「尤度」と呼び、尤度を最大にするパラメタ推定の方法を最尤法という。
































